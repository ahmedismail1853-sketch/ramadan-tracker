<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ØªØªØ¨Ø¹ Ø±Ù…Ø¶Ø§Ù†</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#0b1220; --card:#101a2f; --muted:#8ea0c9; --text:#eaf0ff;
      --accent:#35d0ba; --border:#1d2a4a; --danger:#ff5c7a; --ok:#44e6c6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; background:linear-gradient(180deg,#071028,#0b1220); color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px;background:#0c1630}
    .btn{cursor:pointer;border-radius:12px;border:1px solid var(--border);background:#0c1630;color:var(--text);padding:10px 12px;font:inherit}
    .btn.primary{border-color:rgba(53,208,186,.35);background:linear-gradient(90deg, rgba(53,208,186,.22), rgba(53,208,186,.06))}
    .btn.danger{border-color:rgba(255,92,122,.35);background:rgba(255,92,122,.08)}
    .btn.ghost{background:transparent}
    .row{display:grid;grid-template-columns:1.2fr .8fr; gap:14px; margin-top:14px}
    @media (max-width:980px){ .row{grid-template-columns:1fr} }
    .card{background:rgba(16,26,47,.92);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:15px}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:780px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kpi{padding:12px;border-radius:14px;border:1px solid var(--border);background:#0c1630}
    .kpi .v{font-size:20px;font-weight:800}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:6px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#0c1630;color:var(--muted);font-size:12px;cursor:pointer}
    .tab.active{color:#bff7ee;border-color:rgba(53,208,186,.35);background:rgba(53,208,186,.10)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:620px){ .grid2{grid-template-columns:1fr} }
    label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    input,textarea,select{font:inherit;border-radius:12px;border:1px solid var(--border);background:#0c1630;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:80px;resize:vertical}
    .checkline{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid rgba(29,42,74,.75);border-radius:14px;background:#0c1630}
    input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
    .mini{font-size:12px;color:var(--muted)}
    .split{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .calendar{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;margin-top:10px}
    .day{border-radius:14px;border:1px solid rgba(29,42,74,.75);background:#0c1630;padding:10px;cursor:pointer;min-height:66px;display:flex;flex-direction:column;gap:6px}
    .day .d{font-size:12px;color:var(--muted)}
    .day .s{font-weight:800}
    .day.active{outline:2px solid rgba(53,208,186,.35)}
    .day.done{border-color:rgba(68,230,198,.35);background:rgba(68,230,198,.06)}
    .day.best{border-color:rgba(255,206,86,.35);background:rgba(255,206,86,.07)}
    .daysHead{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;margin-top:8px}
    .daysHead div{font-size:11px;color:var(--muted);text-align:center}
    .goals{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .goal{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;border:1px solid rgba(29,42,74,.75);background:#0c1630}
    .goal .t{flex:1}
    .bar{height:10px;border-radius:999px;border:1px solid var(--border);background:#0a1230;overflow:hidden}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#6aa7ff)}
    a{color:var(--accent);text-decoration:none}
    .sectionTitle{margin:12px 0 6px;font-size:13px;color:#bcd0ff}
    .hint{color:var(--muted);font-size:12px;line-height:1.5}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .dangerText{color:#ffd1da}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸŒ™ Ù…ØªØªØ¨Ø¹ Ø±Ù…Ø¶Ø§Ù†</h1>
        <div class="sub" id="subtitle">Dashboard + ØµÙØ­Ø© Ø§Ù„ÙŠÙˆÙ… + Ù†Ù‚Ø§Ø· + Ø´Ø§Ø±ØªØ³ â€” Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="pill" id="todayPill">â€”</span>
        <button class="btn ghost" id="exportBtn">ØªØµØ¯ÙŠØ±</button>
        <button class="btn ghost" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        <button class="btn ghost" id="settingsBtn">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>
    </header>

    <div class="row">
      <!-- LEFT -->
      <section class="card">
        <div class="split">
          <h2>ğŸ“Š Dashboard</h2>
          <div class="mini" id="ramadanLabel">â€”</div>
        </div>

        <div class="kpis" style="margin-top:10px">
          <div class="kpi">
            <div class="v" id="kpiTotal">â€”</div>
            <div class="l">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ… / 100</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiStreak">â€”</div>
            <div class="l">ğŸ”¥ Streak</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiAvg7">â€”</div>
            <div class="l">Ù…ØªÙˆØ³Ø· 7 Ø£ÙŠØ§Ù…</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiLogged">â€”</div>
            <div class="l">Ø£ÙŠØ§Ù… Ù…Ø³Ø¬Ù„Ø©</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="split">
            <div class="sectionTitle">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
            <div class="mini">Ø§Ø¶ØºØ· ÙŠÙˆÙ… Ù…Ù† Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ø¹Ø±Ø¶Ù‡ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡</div>
          </div>
          <canvas id="lineChart" height="110"></canvas>
        </div>

        <hr style="border:none;border-top:1px solid rgba(29,42,74,.75);margin:14px 0"/>

        <div class="split">
          <h2 style="margin:0">ğŸ“… ØªÙ‚ÙˆÙŠÙ… Ø±Ù…Ø¶Ø§Ù†</h2>
          <div class="mini">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ = Ù…ØªØ³Ø¬Ù„Ø©</div>
        </div>

        <div class="daysHead" aria-hidden="true">
          <div>Ø³</div><div>Ø­</div><div>Ù†</div><div>Ø«</div><div>Ø±</div><div>Ø®</div><div>Ø¬</div>
        </div>
        <div class="calendar" id="calendar"></div>

        <hr style="border:none;border-top:1px solid rgba(29,42,74,.75);margin:14px 0"/>

        <div class="split">
          <h2 style="margin:0">ğŸ¯ ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h2>
          <div class="mini" id="goalsMeta">â€”</div>
        </div>

        <div class="actions">
          <input id="goalInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ø¯Ùâ€¦ Ù…Ø«Ø§Ù„: Ø®ØªÙ…Ø© Ù‚Ø±Ø¢Ù† / Ù‚ÙŠØ§Ù… / ØªÙ‚Ù„ÙŠÙ„ Ø³ÙˆØ´ÙŠØ§Ù„" style="flex:1;min-width:240px"/>
          <button class="btn primary" id="addGoalBtn">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="bar" style="margin-top:10px"><div id="goalsBar"></div></div>
        <div class="goals" id="goalsList"></div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <div class="split">
          <h2>ğŸ“ ØµÙØ­Ø© Ø§Ù„ÙŠÙˆÙ…</h2>
          <span class="pill" id="selectedDayPill">â€”</span>
        </div>

        <div class="tabs" id="tabs"></div>

        <div id="tabContent" style="margin-top:10px"></div>

        <div class="actions">
          <button class="btn primary" id="saveDayBtn">Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…</button>
          <button class="btn danger" id="deleteDayBtn">Ø­Ø°Ù Ø§Ù„ÙŠÙˆÙ…</button>
        </div>

        <p class="hint" style="margin-top:10px">
          âœ… Ø§Ù„Ø³Ù†Ù† ØªÙØ­Ø³Ø¨ Ø¨Ø¶Ø¹Ù Ø§Ù„ÙØ±Ø§Ø¦Ø¶ Ø¯Ø§Ø®Ù„ Ù‚Ø³Ù… Ø§Ù„ØµÙ„ÙˆØ§Øª. <br>
          âœ… Ø§Ù„Ø¯Ø¹Ø§Ø¡: ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© ÙŠØ¸Ù‡Ø± â€œBonus Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ØµØ±â€ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. <br>
          âœ… Ø§Ù„Ù…Ù‡Ù†ÙŠ: ÙƒÙ„ Ù…Ù‡Ù…Ø© âœ” = Ù†Ù‚Ø·Ø© (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10).
        </p>

        <hr style="border:none;border-top:1px solid rgba(29,42,74,.75);margin:14px 0"/>

        <h2 style="margin:0 0 8px">ğŸ© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ (Ø§Ù„ÙŠÙˆÙ…)</h2>
        <canvas id="donutChart" height="140"></canvas>
      </aside>
    </div>

    <!-- SETTINGS MODAL (simple) -->
    <div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);padding:18px;z-index:999">
      <div class="card" style="max-width:720px;margin:0 auto">
        <div class="split">
          <h2 style="margin:0">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
          <button class="btn ghost" id="closeSettings">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="grid2" style="margin-top:10px">
          <label>
            ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø±Ù…Ø¶Ø§Ù† (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)
            <input type="date" id="startDateInput">
          </label>
          <label>
            Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø±Ù…Ø¶Ø§Ù†
            <input type="number" min="29" max="30" id="daysCountInput">
          </label>
        </div>
        <p class="mini" style="margin-top:10px">
          Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¶Ø¨ÙˆØ· Ø¹Ù„Ù‰ 18 ÙØ¨Ø±Ø§ÙŠØ± 2026. Ù„Ùˆ Ø±Ù…Ø¶Ø§Ù† Ø§Ø®ØªÙ„Ù Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§ÙŠØ© Ø¨Ø³ Ø¹Ø¯Ù‘Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ù†Ø§.
        </p>
        <div class="actions">
          <button class="btn primary" id="saveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button class="btn danger" id="resetAll">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <p class="mini dangerText" style="margin-top:10px">
          Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª = Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø².
        </p>
      </div>
    </div>

  </div>

<script>
(() => {
  // --------------------
  // Storage
  // --------------------
  const KEY = "ramadan_pwa_v1";

  const defaultState = () => ({
    version: 1,
    settings: {
      startDate: "2026-02-18", // user specified: 18 Feb (Wed)
      daysCount: 30
    },
    goals: [],
    days: {} // by iso date -> dayData
  });

  const load = () => {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return defaultState();
      const s = JSON.parse(raw);
      return {
        ...defaultState(),
        ...s,
        settings: { ...defaultState().settings, ...(s.settings||{}) },
        goals: Array.isArray(s.goals) ? s.goals : [],
        days: (s.days && typeof s.days === "object") ? s.days : {}
      };
    } catch {
      return defaultState();
    }
  };

  const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));

  // --------------------
  // Helpers (date)
  // --------------------
  const isoToday = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const isoAddDays = (iso, plus) => {
    const dt = new Date(iso);
    dt.setDate(dt.getDate() + plus);
    const yyyy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,"0");
    const dd = String(dt.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const fmtAr = (iso) => {
    const dt = new Date(iso);
    return dt.toLocaleDateString("ar-EG", {weekday:"long", year:"numeric", month:"long", day:"numeric"});
  };

  const dayOfWeek = (iso) => new Date(iso).getDay(); // 0 Sun .. 6 Sat

  // --------------------
  // UI
  // --------------------
  const $ = (id) => document.getElementById(id);

  const ui = {
    todayPill: $("todayPill"),
    ramadanLabel: $("ramadanLabel"),

    kpiTotal: $("kpiTotal"),
    kpiStreak: $("kpiStreak"),
    kpiAvg7: $("kpiAvg7"),
    kpiLogged: $("kpiLogged"),

    calendar: $("calendar"),
    selectedDayPill: $("selectedDayPill"),

    tabs: $("tabs"),
    tabContent: $("tabContent"),
    saveDayBtn: $("saveDayBtn"),
    deleteDayBtn: $("deleteDayBtn"),

    goalInput: $("goalInput"),
    addGoalBtn: $("addGoalBtn"),
    goalsList: $("goalsList"),
    goalsMeta: $("goalsMeta"),
    goalsBar: $("goalsBar"),

    exportBtn: $("exportBtn"),
    importBtn: $("importBtn"),

    settingsBtn: $("settingsBtn"),
    settingsModal: $("settingsModal"),
    closeSettings: $("closeSettings"),
    startDateInput: $("startDateInput"),
    daysCountInput: $("daysCountInput"),
    saveSettings: $("saveSettings"),
    resetAll: $("resetAll")
  };

  let state = load();
  let selectedIso = isoToday();
  let activeTab = "Ø±ÙˆØ­Ø§Ù†ÙŠ";

  // --------------------
  // Scoring system (100)
  // --------------------
  const WEIGHTS = {
    Ø±ÙˆØ­Ø§Ù†ÙŠ: 45,
    ØµØ­ÙŠ: 15,
    Ø´Ø®ØµÙŠ: 10,
    Ø¹Ø§Ø¦Ù„ÙŠ: 8,
    Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ: 7,
    Ù…Ù‡Ù†ÙŠ: 10,
    Ù…Ø§Ø¯ÙŠ: 5
  };

  // Prayers raw points:
  // Fard rak'ah = 1, Sunnah rak'ah = 2 (as requested).
  const PRAYERS = [
    { key:"sun_fajr2", label:"Ø±ÙƒØ¹ØªÙŠ Ø§Ù„ÙØ¬Ø± (Ø³Ù†Ø©)", type:"sun", rakah:2 },
    { key:"fard_fajr", label:"Ø§Ù„ÙØ¬Ø± (ÙØ±Ø¶)", type:"fard", rakah:2 },
    { key:"duha", label:"Ø§Ù„Ø¶Ø­Ù‰ (Ø³Ù†Ø©)", type:"sun", rakah:2 },

    { key:"sun_before_dhuhr4", label:"Ù¤ Ù‚Ø¨Ù„ Ø§Ù„Ø¸Ù‡Ø± (Ø³Ù†Ø©)", type:"sun", rakah:4 },
    { key:"fard_dhuhr", label:"Ø§Ù„Ø¸Ù‡Ø± (ÙØ±Ø¶)", type:"fard", rakah:4 },
    { key:"sun_after_dhuhr2", label:"Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø± (Ø³Ù†Ø©)", type:"sun", rakah:2 },

    { key:"fard_asr", label:"Ø§Ù„Ø¹ØµØ± (ÙØ±Ø¶)", type:"fard", rakah:4 },

    { key:"fard_maghrib", label:"Ø§Ù„Ù…ØºØ±Ø¨ (ÙØ±Ø¶)", type:"fard", rakah:3 },
    { key:"sun_after_maghrib2", label:"Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨ (Ø³Ù†Ø©)", type:"sun", rakah:2 },

    { key:"fard_isha", label:"Ø§Ù„Ø¹Ø´Ø§Ø¡ (ÙØ±Ø¶)", type:"fard", rakah:4 },
    { key:"sun_after_isha2", label:"Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡ (Ø³Ù†Ø©)", type:"sun", rakah:2 },

    { key:"taraweeh8", label:"Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­ (Ù¨ Ø±ÙƒØ¹Ø§Øª)", type:"sun", rakah:8 },
    { key:"witr", label:"Ø§Ù„ÙˆØªØ±", type:"fardlike", rakah:3 }, // treat as 1 each
    // qiyam is numeric input (rakah count) sunnah weight
  ];

  const thikrItems = [
    {key:"thikr_morning", label:"Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", points:2},
    {key:"thikr_evening", label:"Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡", points:2},
    {key:"thikr_salat_nabi", label:"ÙˆØ±Ø¯ Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ", points:1.5},
    {key:"thikr_hawqala", label:"ÙˆØ±Ø¯ Ø§Ù„Ø­ÙˆÙ‚Ù„Ø©", points:1.5},
  ];

  // Du'a times (base) + Friday bonus
  const duaBase = [
    {key:"dua_before_fajr", label:"Ù‚Ø¨Ù„ Ø§Ù„ÙØ¬Ø±", points:1},
    {key:"dua_between_adhan_iqama", label:"Ø¨ÙŠÙ† Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ§Ù„Ø¥Ù‚Ø§Ù…Ø©", points:1},
    {key:"dua_after_salah", label:"Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©", points:1},
    {key:"dua_before_iftar", label:"Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±", points:1},
    {key:"dua_last_third", label:"Ø§Ù„Ø«Ù„Ø« Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ù„ÙŠÙ„", points:1},
    {key:"dua_sujud", label:"ÙÙŠ Ø§Ù„Ø³Ø¬ÙˆØ¯", points:1},
  ];

  const fridayBonus = {key:"dua_friday_asr", label:"Ø§Ù„Ø¬Ù…Ø¹Ø©: Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ØµØ± Ø­ØªÙ‰ Ø§Ù„Ù…ØºØ±Ø¨ (Bonus)", points:2};

  // Health
  const healthItems = [
    {key:"health_teeth", label:"ØªÙØ±ÙŠØ´ Ø§Ù„Ø£Ø³Ù†Ø§Ù†", points:2},
    {key:"health_food", label:"Ø£ÙƒÙ„ ØµØ­ÙŠ", points:3},
    {key:"health_water", label:"Ø´Ø±Ø¨ Ù…Ø§Ø¡ ÙƒØ§ÙÙŠ", points:3},
    {key:"health_sport", label:"Ø±ÙŠØ§Ø¶Ø©", points:3},
    {key:"health_shower", label:"Ø§Ø³ØªØ­Ù…Ø§Ù…", points:2},
    {key:"health_look", label:"Ø§Ù„Ø§Ø¹ØªÙ†Ø§Ø¡ Ø¨Ø§Ù„Ù…Ø¸Ù‡Ø±", points:2},
  ];

  // Personal
  const personalItems = [
    {key:"pers_read", label:"Ù‚Ø±Ø§Ø¡Ø©", points:4},
    {key:"pers_listen", label:"Ø³Ù…Ø§Ø¹", points:3},
    {key:"pers_fun", label:"ØªØ±ÙˆÙŠØ­", points:3},
  ];

  // Family
  const familyItems = [
    {key:"fam_parents", label:"Ø¨Ø± Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†", points:5},
    {key:"fam_help", label:"Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØª", points:3},
  ];

  // Social
  const socialItems = [
    {key:"soc_taarafu", label:"Ù„ØªØ¹Ø§Ø±ÙÙˆØ§", points:7},
  ];

  // Money
  const moneyItems = [
    {key:"money_sadaqa", label:"Ø§Ù„ØµØ¯Ù‚Ø©", points:3},
    {key:"money_earn", label:"Ø§Ù„ÙƒØ³Ø¨ / Ø¥Ù†ØªØ§Ø¬", points:2},
  ];

  // Professional: dynamic tasks, 1 pt each, cap 10
  const profCategories = [
    "Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©",
    "KIT Project",
    "English learning",
    "Ù‚Ù†Ø§Ø© ØªØ±Ø§Ø«",
    "ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø©",
    "Other"
  ];

  const clamp = (n,a,b) => Math.min(b, Math.max(a, n));

  const ensureDay = (iso) => {
    const d = state.days[iso];
    if (d) return d;

    state.days[iso] = {
      // Ø±ÙˆØ­Ø§Ù†ÙŠ
      prayers: Object.fromEntries(PRAYERS.map(p => [p.key, false])),
      qiyamRakah: 0,
      thikr: Object.fromEntries(thikrItems.map(x => [x.key, false])),
      dua: Object.fromEntries([...duaBase, fridayBonus].map(x => [x.key, false])),
      duaFocus: "",

      // other sections
      health: Object.fromEntries(healthItems.map(x => [x.key, false])),
      personal: Object.fromEntries(personalItems.map(x => [x.key, false])),
      family: Object.fromEntries(familyItems.map(x => [x.key, false])),
      social: Object.fromEntries(socialItems.map(x => [x.key, false])),
      money: Object.fromEntries(moneyItems.map(x => [x.key, false])),

      // professional tasks: {category: [{text, done}]}
      professional: Object.fromEntries(profCategories.map(c => [c, [{text:"", done:false}]])),

      notes: ""
    };
    return state.days[iso];
  };

  // Compute raw spiritual subscore then normalize to 45
  const calcPrayersRaw = (day) => {
    let raw = 0;
    for (const p of PRAYERS) {
      const checked = !!day.prayers[p.key];
      if (!checked) continue;

      if (p.type === "fard") raw += p.rakah * 1;
      else if (p.type === "sun") raw += p.rakah * 2;
      else raw += p.rakah * 1; // witr treated like 1 each
    }
    const qiyam = clamp(+day.qiyamRakah || 0, 0, 60);
    raw += qiyam * 2; // qiyam sunnah
    return raw;
  };

  const calcThikr = (day) =>
    thikrItems.reduce((acc,x)=> acc + (day.thikr[x.key] ? x.points : 0), 0);

  const isFriday = (iso) => {
    // JS: 5 is Friday? Actually: 0 Sun, 1 Mon, 2 Tue, 3 Wed, 4 Thu, 5 Fri, 6 Sat
    return dayOfWeek(iso) === 5;
  };

  const calcDua = (day, iso) => {
    const items = [...duaBase, ...(isFriday(iso) ? [fridayBonus] : [])];
    return items.reduce((acc,x)=> acc + (day.dua[x.key] ? x.points : 0), 0);
  };

  const calcSpiritual = (day, iso) => {
    // We want total spiritual out of 45 with sub-allocations:
    // Prayers: 30 (normalized), Thikr: 7, Dua: 8  => 45
    const prayersRaw = calcPrayersRaw(day);

    // define maxRaw for normalization: assume doing all listed prayers (except qiyam) gives baseline maxRaw
    // and allow qiyam to help reach cap but not exceed.
    const baselineMaxRaw =
      PRAYERS.reduce((acc,p)=>{
        const mult = (p.type === "sun") ? 2 : 1;
        return acc + p.rakah * mult;
      }, 0) + (10 * 2); // allow qiyam up to 10 rakah to hit full cap comfortably

    const prayersNorm = clamp((prayersRaw / baselineMaxRaw) * 30, 0, 30);

    const thikr = clamp(calcThikr(day), 0, 7);
    const dua = clamp(calcDua(day, iso), 0, 8);

    return {
      prayers: Math.round(prayersNorm * 10) / 10,
      thikr: Math.round(thikr * 10) / 10,
      dua: Math.round(dua * 10) / 10,
      total: Math.round((prayersNorm + thikr + dua) * 10) / 10
    };
  };

  const sumCheckItems = (dayObj, items, cap) => {
    const s = items.reduce((acc,x)=> acc + (dayObj[x.key] ? x.points : 0), 0);
    return cap != null ? clamp(s, 0, cap) : s;
  };

  const calcProfessional = (day) => {
    // 1 point per done task, cap 10
    let done = 0;
    for (const cat of profCategories) {
      const tasks = day.professional[cat] || [];
      for (const t of tasks) if (t && t.done && t.text && t.text.trim()) done++;
    }
    done = clamp(done, 0, 10);
    return done;
  };

  const calcAll = (iso) => {
    const day = ensureDay(iso);

    const spiritual = calcSpiritual(day, iso);
    const health = clamp(sumCheckItems(day.health, healthItems), 0, WEIGHTS.ØµØ­ÙŠ);
    const personal = clamp(sumCheckItems(day.personal, personalItems), 0, WEIGHTS.Ø´Ø®ØµÙŠ);
    const family = clamp(sumCheckItems(day.family, familyItems), 0, WEIGHTS.Ø¹Ø§Ø¦Ù„ÙŠ);
    const social = clamp(sumCheckItems(day.social, socialItems), 0, WEIGHTS.Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ);
    const money = clamp(sumCheckItems(day.money, moneyItems), 0, WEIGHTS.Ù…Ø§Ø¯ÙŠ);

    const professional = clamp(calcProfessional(day), 0, WEIGHTS.Ù…Ù‡Ù†ÙŠ);

    const total = Math.round((spiritual.total + health + personal + family + social + professional + money) * 10) / 10;

    return {
      breakdown: {
        "Ø±ÙˆØ­Ø§Ù†ÙŠ": spiritual.total,
        "ØµØ­ÙŠ": health,
        "Ø´Ø®ØµÙŠ": personal,
        "Ø¹Ø§Ø¦Ù„ÙŠ": family,
        "Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ": social,
        "Ù…Ù‡Ù†ÙŠ": professional,
        "Ù…Ø§Ø¯ÙŠ": money
      },
      spiritualParts: spiritual,
      total
    };
  };

  // Streak: consecutive days with total >= 70 (tunable)
  const streakThreshold = 70;
  const calcStreak = () => {
    let streak = 0;
    let cur = isoToday();
    while (true) {
      const has = state.days[cur];
      if (!has) break;
      const t = calcAll(cur).total;
      if (t < streakThreshold) break;
      streak++;
      cur = isoAddDays(cur, -1);
    }
    return streak;
  };

  const avgLastN = (n=7) => {
    const dates = Object.keys(state.days).sort();
    const last = dates.slice(-n);
    if (!last.length) return null;
    const sum = last.reduce((acc,iso)=> acc + calcAll(iso).total, 0);
    return Math.round((sum/last.length)*10)/10;
  };

  // --------------------
  // Ramadan calendar generation
  // --------------------
  const getRamadanDates = () => {
    const start = state.settings.startDate;
    const count = clamp(+state.settings.daysCount || 30, 29, 30);
    return Array.from({length: count}, (_,i)=> isoAddDays(start, i));
  };

  const isInRamadan = (iso) => {
    const dates = getRamadanDates();
    return iso >= dates[0] && iso <= dates[dates.length-1];
  };

  // --------------------
  // Tabs + Render
  // --------------------
  const TAB_KEYS = ["Ø±ÙˆØ­Ø§Ù†ÙŠ","ØµØ­ÙŠ","Ø´Ø®ØµÙŠ","Ø¹Ø§Ø¦Ù„ÙŠ","Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ù…Ù‡Ù†ÙŠ","Ù…Ø§Ø¯ÙŠ","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];

  const renderTabs = () => {
    ui.tabs.innerHTML = "";
    for (const t of TAB_KEYS) {
      const b = document.createElement("button");
      b.className = "tab" + (t === activeTab ? " active" : "");
      b.textContent = t;
      b.addEventListener("click", ()=>{
        activeTab = t;
        renderTabs();
        renderTabContent();
      });
      ui.tabs.appendChild(b);
    }
  };

  const mkCheck = (label, checked, onChange) => {
    const line = document.createElement("div");
    line.className = "checkline";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!checked;
    cb.addEventListener("change", ()=> onChange(cb.checked));
    const txt = document.createElement("div");
    txt.textContent = label;
    txt.style.flex = "1";
    line.appendChild(cb);
    line.appendChild(txt);
    return line;
  };

  const renderTabContent = () => {
    const day = ensureDay(selectedIso);
    ui.selectedDayPill.textContent = fmtAr(selectedIso);

    const wrap = document.createElement("div");

    if (activeTab === "Ø±ÙˆØ­Ø§Ù†ÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ•Œ Ø§Ù„ØµÙ„ÙˆØ§Øª"}));

      // prayers list
      for (const p of PRAYERS) {
        const label = p.label;
        wrap.appendChild(mkCheck(label, day.prayers[p.key], (v)=>{ day.prayers[p.key]=v; }));
      }

      // qiyam numeric
      const q = document.createElement("div");
      q.className = "checkline";
      q.style.display = "grid";
      q.style.gridTemplateColumns = "1fr 160px";
      q.style.gap = "10px";
      q.style.alignItems = "center";
      q.innerHTML = `<div>Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„ (Ø§ÙƒØªØ¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ¹Ø§Øª)</div>`;
      const inp = document.createElement("input");
      inp.type = "number";
      inp.min = "0";
      inp.max = "60";
      inp.value = day.qiyamRakah || 0;
      inp.addEventListener("input", ()=> day.qiyamRakah = clamp(+inp.value||0,0,60));
      q.appendChild(inp);
      wrap.appendChild(q);

      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ“¿ Ø§Ù„Ø£Ø°ÙƒØ§Ø±"}));
      for (const x of thikrItems) {
        wrap.appendChild(mkCheck(x.label, day.thikr[x.key], (v)=>{ day.thikr[x.key]=v; }));
      }

      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ¤² Ø§Ù„Ø¯Ø¹Ø§Ø¡"}));
      const duaItemsToday = [...duaBase, ...(isFriday(selectedIso) ? [fridayBonus] : [])];
      for (const x of duaItemsToday) {
        wrap.appendChild(mkCheck(x.label, day.dua[x.key], (v)=>{ day.dua[x.key]=v; }));
      }

      const focus = document.createElement("label");
      focus.textContent = "Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù„ÙŠ Ù‡ØªØ±ÙƒØ² Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ…";
      const ta = document.createElement("textarea");
      ta.value = day.duaFocus || "";
      ta.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©â€¦";
      ta.addEventListener("input", ()=> day.duaFocus = ta.value);
      focus.appendChild(ta);
      wrap.appendChild(focus);

      const sc = calcAll(selectedIso);
      const hint = document.createElement("div");
      hint.className = "mini";
      hint.style.marginTop = "8px";
      hint.textContent = `Ø±ÙˆØ­Ø§Ù†ÙŠ Ø§Ù„ÙŠÙˆÙ…: ${sc.breakdown["Ø±ÙˆØ­Ø§Ù†ÙŠ"]}/45 (ØµÙ„ÙˆØ§Øª ${sc.spiritualParts.prayers}/30 + Ø£Ø°ÙƒØ§Ø± ${sc.spiritualParts.thikr}/7 + Ø¯Ø¹Ø§Ø¡ ${sc.spiritualParts.dua}/8)`;
      wrap.appendChild(hint);
    }

    if (activeTab === "ØµØ­ÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ’ª Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµØ­ÙŠ"}));
      for (const x of healthItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.health[x.key], (v)=>{ day.health[x.key]=v; }));
      }
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`Ø­Ø¯ Ø£Ù‚ØµÙ‰: ${WEIGHTS.ØµØ­ÙŠ} Ù†Ù‚Ø·Ø©`}));      
    }

    if (activeTab === "Ø´Ø®ØµÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ§  Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ"}));
      for (const x of personalItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.personal[x.key], (v)=>{ day.personal[x.key]=v; }));
      }
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`Ø­Ø¯ Ø£Ù‚ØµÙ‰: ${WEIGHTS.Ø´Ø®ØµÙŠ} Ù†Ù‚Ø·Ø©`}));      
    }

    if (activeTab === "Ø¹Ø§Ø¦Ù„ÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ"}));
      for (const x of familyItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.family[x.key], (v)=>{ day.family[x.key]=v; }));
      }
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`Ø­Ø¯ Ø£Ù‚ØµÙ‰: ${WEIGHTS.Ø¹Ø§Ø¦Ù„ÙŠ} Ù†Ù‚Ø·Ø©`}));      
    }

    if (activeTab === "Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸŒ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ"}));
      for (const x of socialItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.social[x.key], (v)=>{ day.social[x.key]=v; }));
      }
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`Ø­Ø¯ Ø£Ù‚ØµÙ‰: ${WEIGHTS.Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ} Ù†Ù‚Ø·Ø©`}));      
    }

    if (activeTab === "Ù…Ù‡Ù†ÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ’¼ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ù‡Ù†ÙŠ"}));
      const info = document.createElement("div");
      info.className = "mini";
      info.textContent = "ÙƒÙ„ Ù…Ù‡Ù…Ø© âœ” = 1 Ù†Ù‚Ø·Ø© (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10). Ø§ÙƒØªØ¨ Ù…Ù‡Ø§Ù…Ùƒ ØªØ­Øª ÙƒÙ„ Ø¨Ù†Ø¯.";
      wrap.appendChild(info);

      for (const cat of profCategories) {
        const title = document.createElement("div");
        title.className = "sectionTitle";
        title.textContent = "â€¢ " + cat;
        wrap.appendChild(title);

        const tasks = day.professional[cat] || [{text:"", done:false}];

        tasks.forEach((t, idx) => {
          const line = document.createElement("div");
          line.className = "checkline";
          line.style.display = "grid";
          line.style.gridTemplateColumns = "28px 1fr 80px";
          line.style.gap = "10px";
          line.style.alignItems = "center";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = !!t.done;
          cb.addEventListener("change", ()=> { t.done = cb.checked; });

          const inp = document.createElement("input");
          inp.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø©â€¦";
          inp.value = t.text || "";
          inp.addEventListener("input", ()=> { t.text = inp.value; });

          const del = document.createElement("button");
          del.className = "btn danger";
          del.textContent = "Ø­Ø°Ù";
          del.addEventListener("click", ()=>{
            const arr = day.professional[cat] || [];
            arr.splice(idx,1);
            if (arr.length === 0) arr.push({text:"", done:false});
            day.professional[cat] = arr;
            renderTabContent();
          });

          line.appendChild(cb);
          line.appendChild(inp);
          line.appendChild(del);
          wrap.appendChild(line);
        });

        const add = document.createElement("button");
        add.className = "btn ghost";
        add.textContent = "â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©";
        add.addEventListener("click", ()=>{
          day.professional[cat] = (day.professional[cat] || []);
          day.professional[cat].push({text:"", done:false});
          renderTabContent();
        });
        wrap.appendChild(add);
      }

      const sc = calcAll(selectedIso);
      const hint = document.createElement("div");
      hint.className = "mini";
      hint.style.marginTop = "8px";
      hint.textContent = `Ù…Ù‡Ù†ÙŠ Ø§Ù„ÙŠÙˆÙ…: ${sc.breakdown["Ù…Ù‡Ù†ÙŠ"]}/10`;
      wrap.appendChild(hint);
    }

    if (activeTab === "Ù…Ø§Ø¯ÙŠ") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ’° Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø§Ø¯ÙŠ"}));
      for (const x of moneyItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.money[x.key], (v)=>{ day.money[x.key]=v; }));
      }
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`Ø­Ø¯ Ø£Ù‚ØµÙ‰: ${WEIGHTS.Ù…Ø§Ø¯ÙŠ} Ù†Ù‚Ø·Ø©`}));      
    }

    if (activeTab === "Ù…Ù„Ø§Ø­Ø¸Ø§Øª") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"ğŸ—’ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…"}));
      const note = document.createElement("textarea");
      note.value = day.notes || "";
      note.placeholder = "Ø§ÙƒØªØ¨ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ/ØªØ¹Ù„ÙŠÙ‚Ùƒ/Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ÙŠÙˆÙ…â€¦";
      note.addEventListener("input", ()=> day.notes = note.value);
      wrap.appendChild(note);

      const sc = calcAll(selectedIso);
      const box = document.createElement("div");
      box.className = "mini";
      box.style.marginTop = "10px";
      box.textContent =
        `Total: ${sc.total}/100 â€” Ø±ÙˆØ­Ø§Ù†ÙŠ ${sc.breakdown["Ø±ÙˆØ­Ø§Ù†ÙŠ"]}/45 â€¢ ØµØ­ÙŠ ${sc.breakdown["ØµØ­ÙŠ"]}/15 â€¢ Ø´Ø®ØµÙŠ ${sc.breakdown["Ø´Ø®ØµÙŠ"]}/10 â€¢ Ø¹Ø§Ø¦Ù„ÙŠ ${sc.breakdown["Ø¹Ø§Ø¦Ù„ÙŠ"]}/8 â€¢ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ${sc.breakdown["Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ"]}/7 â€¢ Ù…Ù‡Ù†ÙŠ ${sc.breakdown["Ù…Ù‡Ù†ÙŠ"]}/10 â€¢ Ù…Ø§Ø¯ÙŠ ${sc.breakdown["Ù…Ø§Ø¯ÙŠ"]}/5`;
      wrap.appendChild(box);
    }

    ui.tabContent.innerHTML = "";
    ui.tabContent.appendChild(wrap);
  };

  // --------------------
  // Calendar render
  // --------------------
  const renderCalendar = () => {
    ui.calendar.innerHTML = "";
    const ramadanDates = getRamadanDates();

    // pad grid to start on Saturday? We'll pad by weekday to align (Sun..Sat)
    // Our header is: Sat Sun Mon Tue Wed Thu Fri visually RTL; We'll just render simple 30 cards without padding for now
    // But we will render in a consistent 7-column grid with padding based on weekday.
    const startDow = dayOfWeek(ramadanDates[0]); // 0 Sun
    // We want columns: Sat(6), Sun(0), Mon(1), Tue(2), Wed(3), Thu(4), Fri(5)
    const colIndex = (dow) => {
      // Map: Sat=0, Sun=1, Mon=2, Tue=3, Wed=4, Thu=5, Fri=6
      if (dow === 6) return 0;
      return dow + 1; // Sun->1 ... Fri->6
    };
    const pad = colIndex(startDow);
    for (let i=0;i<pad;i++){
      const empty = document.createElement("div");
      empty.style.opacity = "0";
      empty.className = "day";
      empty.style.pointerEvents = "none";
      ui.calendar.appendChild(empty);
    }

    ramadanDates.forEach((iso, idx) => {
      const score = state.days[iso] ? calcAll(iso).total : null;

      const cell = document.createElement("div");
      cell.className = "day";
      if (iso === selectedIso) cell.classList.add("active");
      if (score != null) cell.classList.add("done");
      if (score != null && score >= 85) cell.classList.add("best");

      cell.innerHTML = `
        <div class="d">Ø§Ù„ÙŠÙˆÙ… ${idx+1}</div>
        <div class="mini">${fmtAr(iso).replace(/^.+ØŒ\s*/,"")}</div>
        <div class="s">${score == null ? "â€”" : (score + "/100")}</div>
      `;
      cell.addEventListener("click", ()=>{
        selectedIso = iso;
        ensureDay(selectedIso);
        renderAll();
      });

      ui.calendar.appendChild(cell);
    });
  };

  // --------------------
  // Goals
  // --------------------
  const renderGoals = () => {
    ui.goalsList.innerHTML = "";

    if (!state.goals.length) {
      const x = document.createElement("div");
      x.className = "mini";
      x.textContent = "Ù…ÙÙŠØ´ Ø£Ù‡Ø¯Ø§Ù Ù„Ø³Ù‡ â€” Ø§ÙƒØªØ¨ Ù‡Ø¯Ù Ø¨Ø³ÙŠØ· ÙˆØªØ§Ø¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ.";
      ui.goalsList.appendChild(x);
      ui.goalsMeta.textContent = "0/0";
      ui.goalsBar.style.width = "0%";
      return;
    }

    const done = state.goals.filter(g=>g.done).length;
    ui.goalsMeta.textContent = `${done}/${state.goals.length}`;
    ui.goalsBar.style.width = `${(done/state.goals.length)*100}%`;

    state.goals.forEach((g, i) => {
      const row = document.createElement("div");
      row.className = "goal";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!g.done;
      cb.addEventListener("change", ()=>{
        g.done = cb.checked;
        save(state);
        renderAll();
      });

      const t = document.createElement("div");
      t.className = "t";
      t.textContent = g.text;
      t.style.textDecoration = g.done ? "line-through" : "none";
      t.style.color = g.done ? "rgba(234,240,255,.70)" : "var(--text)";

      const del = document.createElement("button");
      del.className = "btn danger";
      del.textContent = "Ø­Ø°Ù";
      del.addEventListener("click", ()=>{
        state.goals.splice(i,1);
        save(state);
        renderAll();
      });

      row.appendChild(cb);
      row.appendChild(t);
      row.appendChild(del);
      ui.goalsList.appendChild(row);
    });
  };

  // --------------------
  // Charts
  // --------------------
  let lineChart, donutChart;

  const renderCharts = () => {
    const ramadanDates = getRamadanDates();

    // Line: daily total (ramadan range)
    const labels = ramadanDates.map((iso, idx)=> `ÙŠ${idx+1}`);
    const data = ramadanDates.map(iso => state.days[iso] ? calcAll(iso).total : null);

    const ctx1 = document.getElementById("lineChart").getContext("2d");
    if (lineChart) lineChart.destroy();
    lineChart = new Chart(ctx1, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Ø§Ù„Ù†Ù‚Ø§Ø· / 100",
          data,
          spanGaps: true,
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: { suggestedMin: 0, suggestedMax: 100 }
        }
      }
    });

    // Donut: breakdown for selected day
    const sc = calcAll(selectedIso);
    const keys = Object.keys(sc.breakdown);
    const vals = keys.map(k => sc.breakdown[k]);

    const ctx2 = document.getElementById("donutChart").getContext("2d");
    if (donutChart) donutChart.destroy();
    donutChart = new Chart(ctx2, {
      type: "doughnut",
      data: {
        labels: keys,
        datasets: [{
          data: vals,
          borderWidth: 1
        }]
      },
      options: {
        plugins: { legend: { position: "bottom" } }
      }
    });
  };

  // --------------------
  // KPIs
  // --------------------
  const renderKPIs = () => {
    const totalToday = state.days[selectedIso] ? calcAll(selectedIso).total : 0;
    ui.kpiTotal.textContent = `${totalToday}`;

    ui.kpiStreak.textContent = calcStreak();
    const a7 = avgLastN(7);
    ui.kpiAvg7.textContent = a7 == null ? "â€”" : a7;

    ui.kpiLogged.textContent = Object.keys(state.days).length;

    ui.todayPill.textContent = `Ø§Ù„ÙŠÙˆÙ…: ${fmtAr(isoToday())}`;
    const ramDates = getRamadanDates();
    ui.ramadanLabel.textContent = `Ø±Ù…Ø¶Ø§Ù†: Ù…Ù† ${fmtAr(ramDates[0])} Ø¥Ù„Ù‰ ${fmtAr(ramDates[ramDates.length-1])}`;
  };

  // --------------------
  // Save / Delete Day
  // --------------------
  ui.saveDayBtn.addEventListener("click", ()=>{
    ensureDay(selectedIso);
    save(state);
    renderAll();
  });

  ui.deleteDayBtn.addEventListener("click", ()=>{
    if (state.days[selectedIso]) {
      delete state.days[selectedIso];
      save(state);
      ensureDay(selectedIso); // recreate empty for UI
      delete state.days[selectedIso]; // keep it truly deleted unless saved
      renderAll();
    }
  });

  // Goals add
  ui.addGoalBtn.addEventListener("click", ()=>{
    const txt = (ui.goalInput.value || "").trim();
    if (!txt) return;
    state.goals.unshift({ text: txt, done:false, createdAt: Date.now() });
    ui.goalInput.value = "";
    save(state);
    renderAll();
  });

  // Export / Import
  ui.exportBtn.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ramadan-tracker-backup-${isoToday()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  ui.importBtn.addEventListener("click", ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = () => {
      const file = inp.files && inp.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const parsed = JSON.parse(r.result);
          if(!parsed || typeof parsed !== "object") throw new Error("bad");
          state = {
            ...defaultState(),
            ...parsed,
            settings: { ...defaultState().settings, ...(parsed.settings||{}) },
            goals: Array.isArray(parsed.goals) ? parsed.goals : [],
            days: (parsed.days && typeof parsed.days === "object") ? parsed.days : {}
          };
          save(state);
          renderAll();
        }catch{
          alert("Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.");
        }
      };
      r.readAsText(file);
    };
    inp.click();
  });

  // Settings modal
  const openSettings = () => {
    ui.startDateInput.value = state.settings.startDate;
    ui.daysCountInput.value = state.settings.daysCount;
    ui.settingsModal.style.display = "block";
  };
  const closeSettings = () => ui.settingsModal.style.display = "none";

  ui.settingsBtn.addEventListener("click", openSettings);
  ui.closeSettings.addEventListener("click", closeSettings);
  ui.settingsModal.addEventListener("click", (e)=>{
    if (e.target === ui.settingsModal) closeSettings();
  });

  ui.saveSettings.addEventListener("click", ()=>{
    const d = ui.startDateInput.value || "2026-02-18";
    const c = clamp(+ui.daysCountInput.value || 30, 29, 30);
    state.settings.startDate = d;
    state.settings.daysCount = c;

    // if selected day outside new range, snap to start
    const r = getRamadanDates();
    if (!isInRamadan(selectedIso)) selectedIso = r[0];

    save(state);
    closeSettings();
    renderAll();
  });

  ui.resetAll.addEventListener("click", ()=>{
    const ok = confirm("Ù…ØªØ£ÙƒØ¯ØŸ Ù‡ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.");
    if (!ok) return;
    state = defaultState();
    save(state);
    selectedIso = state.settings.startDate;
    closeSettings();
    renderAll();
  });

  // --------------------
  // Main render
  // --------------------
  const renderAll = () => {
    // default selected to Ramadan start if within Ramadan; else today if within; else start
    const ram = getRamadanDates();
    if (!isInRamadan(selectedIso)) {
      selectedIso = isInRamadan(isoToday()) ? isoToday() : ram[0];
    }

    renderKPIs();
    renderCalendar();
    renderGoals();
    renderTabs();
    renderTabContent();
    renderCharts();
  };

  // init
  ensureDay(selectedIso);
  renderAll();

  // register SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
})();
</script>
</body>
</html>