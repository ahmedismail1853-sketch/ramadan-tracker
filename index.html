// --------------------
  // Actions
  // --------------------
  ui.saveDayBtn.addEventListener("click", ()=>{
    saveDay(selectedIso);
    renderAll();
  });

  ui.deleteDayBtn.addEventListener("click", ()=>{
    deleteDay(selectedIso);
    renderAll();
  });

  ui.addGoalBtn.addEventListener("click", ()=>{
    const txt = (ui.goalInput.value || "").trim();
    if (!txt) return;
    state.goals.unshift({ text: txt, done:false, createdAt: Date.now() });
    ui.goalInput.value = "";
    save(state);
    renderAll();
  });

  ui.exportBtn.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = ramadan-tracker-backup-${isoToday()}.json;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  ui.importBtn.addEventListener("click", ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = () => {
      const file = inp.files && inp.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const parsed = JSON.parse(r.result);
          if(!parsed || typeof parsed !== "object") throw new Error("bad");
          state = {
            ...defaultState(),
            ...parsed,
            settings: { ...defaultState().settings, ...(parsed.settings||{}) },
            goals: Array.isArray(parsed.goals) ? parsed.goals : [],
            days: (parsed.days && typeof parsed.days === "object") ? parsed.days : {}
          };
          save(state);
          renderAll();
        }catch{
          alert("ملف الاستيراد غير صالح.");
        }
      };
      r.readAsText(file);
    };
    inp.click();
  });

  // Settings modal
  const openSettings = () => {
    ui.startDateInput.value = state.settings.startDate;
    ui.daysCountInput.value = state.settings.daysCount;
    ui.settingsModal.style.display = "block";
  };
  const closeSettings = () => ui.settingsModal.style.display = "none";

  ui.settingsBtn.addEventListener("click", openSettings);
  ui.closeSettings.addEventListener("click", closeSettings);
  ui.settingsModal.addEventListener("click", (e)=>{
    if (e.target === ui.settingsModal) closeSettings();
  });

  ui.saveSettings.addEventListener("click", ()=>{
    const d = ui.startDateInput.value || "2026-02-18";
    const c = clamp(+ui.daysCountInput.value || 30, 29, 30);
    state.settings.startDate = d;
    state.settings.daysCount = c;

    const r = getRamadanDates();
    if (!isInRamadan(selectedIso)) selectedIso = r[0];

    save(state);
    closeSettings();
    renderAll();
  });

  ui.resetAll.addEventListener("click", ()=>{
    const ok = confirm("متأكد؟ هتمسح كل البيانات نهائيًا.");
    if (!ok) return;
    state = defaultState();
    save(state);
    selectedIso = state.settings.startDate;
    closeSettings();
    renderAll();
  });

  // --------------------
  // Main render
  // --------------------
  const renderAll = () => {
    const ram = getRamadanDates();
    if (!isInRamadan(selectedIso)) {
      selectedIso = isInRamadan(isoToday()) ? isoToday() : ram[0];
    }

    renderTabs();
    renderKPIs();
    renderCalendar();
    renderGoals();
    renderTabContent();
    renderCharts();
  };

  // init
  renderAll();

  // register SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
})();
</script>
</body>
</html>
