<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุชุชุจุน ุฑูุถุงู</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#0b1220; --card:#101a2f; --muted:#8ea0c9; --text:#eaf0ff;
      --accent:#35d0ba; --border:#1d2a4a; --danger:#ff5c7a; --ok:#44e6c6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; background:linear-gradient(180deg,#071028,#0b1220); color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px;background:#0c1630}
    .btn{cursor:pointer;border-radius:12px;border:1px solid var(--border);background:#0c1630;color:var(--text);padding:10px 12px;font:inherit}
    .btn.primary{border-color:rgba(53,208,186,.35);background:linear-gradient(90deg, rgba(53,208,186,.22), rgba(53,208,186,.06))}
    .btn.danger{border-color:rgba(255,92,122,.35);background:rgba(255,92,122,.08)}
    .btn.ghost{background:transparent}
    .row{display:grid;grid-template-columns:1.2fr .8fr; gap:14px; margin-top:14px}
    @media (max-width:980px){ .row{grid-template-columns:1fr} }
    .card{background:rgba(16,26,47,.92);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:15px}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:780px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kpi{padding:12px;border-radius:14px;border:1px solid var(--border);background:#0c1630}
    .kpi .v{font-size:20px;font-weight:800}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:6px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#0c1630;color:var(--muted);font-size:12px;cursor:pointer}
    .tab.active{color:#bff7ee;border-color:rgba(53,208,186,.35);background:rgba(53,208,186,.10)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:620px){ .grid2{grid-template-columns:1fr} }
    label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    input,textarea,select{font:inherit;border-radius:12px;border:1px solid var(--border);background:#0c1630;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:80px;resize:vertical}
    .checkline{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid rgba(29,42,74,.75);border-radius:14px;background:#0c1630}
    input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
    .mini{font-size:12px;color:var(--muted)}
    .split{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .calendar{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;margin-top:10px}
    .day{border-radius:14px;border:1px solid rgba(29,42,74,.75);background:#0c1630;padding:10px;cursor:pointer;min-height:66px;display:flex;flex-direction:column;gap:6px}
    .day .d{font-size:12px;color:var(--muted)}
    .day .s{font-weight:800}
    .day.active{outline:2px solid rgba(53,208,186,.35)}
    .day.done{border-color:rgba(68,230,198,.35);background:rgba(68,230,198,.06)}
    .day.best{border-color:rgba(255,206,86,.35);background:rgba(255,206,86,.07)}
    .daysHead{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;margin-top:8px}
    .daysHead div{font-size:11px;color:var(--muted);text-align:center}
    .goals{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .goal{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;border:1px solid rgba(29,42,74,.75);background:#0c1630}
    .goal .t{flex:1}
    .bar{height:10px;border-radius:999px;border:1px solid var(--border);background:#0a1230;overflow:hidden}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#6aa7ff)}
    a{color:var(--accent);text-decoration:none}
    .sectionTitle{margin:12px 0 6px;font-size:13px;color:#bcd0ff}
    .hint{color:var(--muted);font-size:12px;line-height:1.5}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .dangerText{color:#ffd1da}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>๐ ูุชุชุจุน ุฑูุถุงู</h1>
        <div class="sub" id="subtitle">Dashboard + ุตูุญุฉ ุงูููู + ููุงุท + ุดุงุฑุชุณ โ ุจูุงูุงุชู ุนูู ุฌูุงุฒู ููุท.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="pill" id="todayPill">โ</span>
        <button class="btn ghost" id="exportBtn">ุชุตุฏูุฑ</button>
        <button class="btn ghost" id="importBtn">ุงุณุชูุฑุงุฏ</button>
        <button class="btn ghost" id="settingsBtn">ุฅุนุฏุงุฏุงุช</button>
      </div>
    </header>

    <div class="row">
      <section class="card">
        <div class="split">
          <h2>๐ Dashboard</h2>
          <div class="mini" id="ramadanLabel">โ</div>
        </div>

        <div class="kpis" style="margin-top:10px">
          <div class="kpi">
            <div class="v" id="kpiTotal">โ</div>
            <div class="l">ูุฌููุน ุงูููู / 100</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiStreak">โ</div>
            <div class="l">๐ฅ Streak</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiAvg7">โ</div>
            <div class="l">ูุชูุณุท 7 ุฃูุงู (ูุญููุธุฉ)</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiLogged">โ</div>
            <div class="l">ุฃูุงู ูุญููุธุฉ</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="split">
            <div class="sectionTitle">๐ ุงูุชูุฏู ุงููููู (ูุญููุธ ููุท)</div>
            <div class="mini">ุงุถุบุท ููู ูู ุงูุชูููู ูุนุฑุถู ูุชุนุฏููู</div>
          </div>
          <canvas id="lineChart" height="110"></canvas>
        </div>

        <hr style="border:none;border-top:1px solid rgba(29,42,74,.75);margin:14px 0"/>

        <div class="split">
          <h2 style="margin:0">๐ ุชูููู ุฑูุถุงู</h2>
          <div class="mini">ุงูุฃูุงู ุงูุฎุถุฑุงุก = ูุญููุธุฉ ููุท</div>
        </div>

        <div class="daysHead" aria-hidden="true">
          <div>ุณ</div><div>ุญ</div><div>ู</div><div>ุซ</div><div>ุฑ</div><div>ุฎ</div><div>ุฌ</div>
        </div>
        <div class="calendar" id="calendar"></div>

        <hr style="border:none;border-top:1px solid rgba(29,42,74,.75);margin:14px 0"/>

        <div class="split">
          <h2 style="margin:0">๐ฏ ุชูุฏู ุงูุฃูุฏุงู</h2>
          <div class="mini" id="goalsMeta">โ</div>
        </div>

        <div class="actions">
          <input id="goalInput" placeholder="ุงูุชุจ ูุฏูโฆ ูุซุงู: ุฎุชูุฉ ูุฑุขู / ููุงู / ุชูููู ุณูุดูุงู" style="flex:1;min-width:240px"/>
          <button class="btn primary" id="addGoalBtn">ุฅุถุงูุฉ</button>
        </div>
        <div class="bar" style="margin-top:10px"><div id="goalsBar"></div></div>
        <div class="goals" id="goalsList"></div>
      </section>

      <aside class="card">
        <div class="split">
          <h2>๐ ุตูุญุฉ ุงูููู</h2>
          <span class="pill" id="selectedDayPill">โ</span>
        </div>

        <div class="tabs" id="tabs"></div>
        <div id="tabContent" style="margin-top:10px"></div>

        <div class="actions">
          <button class="btn primary" id="saveDayBtn">ุญูุธ ุงูููู</button>
          <button class="btn danger" id="deleteDayBtn">ุญุฐู ุงูููู</button>
        </div>

        <p class="hint" style="margin-top:10px">
          โ ุฃู ุชุบููุฑ ุนูู checkbox/ูุชุงุจุฉ ุณููุญุฏูุซ ุงูุณููุฑ ูุงูุดุงุฑุชุณ ููุฑูุง (Live). <br>
          โ ุงูููู ูุง ูุตุจุญ โูุญููุธูุงโ ุฅูุง ุนูุฏ ุงูุถุบุท ุนูู <b>ุญูุธ ุงูููู</b>. <br>
          โ ุงูุฌูุนุฉ: ูุธูุฑ โBonus ุจุนุฏ ุงูุนุตุฑโ ุชููุงุฆููุง ุถูู ุงูุฏุนุงุก. <br>
          โ ุงููุฑุขู: ูู 4 ุตูุญุงุช = 1 ููุทุฉ (ุญุฏ ุฃูุตู 5). <br>
          โ Bonus Tasks: ูู ูู ุฌุงูุจ ุชูุฏุฑ ุชุถูู ููุงู ุฅุถุงููุฉ ุจููุงุท.
        </p>

        <hr style="border:none;border-top:1px solid rgba(29,42,74,.75);margin:14px 0"/>

        <h2 style="margin:0 0 8px">๐ฉ ุชูุฒูุน ุงูุฌูุงูุจ (Live)</h2>
        <canvas id="donutChart" height="140"></canvas>
      </aside>
    </div>

    <div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);padding:18px;z-index:999">
      <div class="card" style="max-width:720px;margin:0 auto">
        <div class="split">
          <h2 style="margin:0">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h2>
          <button class="btn ghost" id="closeSettings">ุฅุบูุงู</button>
        </div>
        <div class="grid2" style="margin-top:10px">
          <label>
            ุชุงุฑูุฎ ุจุฏุงูุฉ ุฑูุถุงู (ูููุงุฏู)
            <input type="date" id="startDateInput">
          </label>
          <label>
            ุนุฏุฏ ุฃูุงู ุฑูุถุงู
            <input type="number" min="29" max="30" id="daysCountInput">
          </label>
        </div>
        <p class="mini" style="margin-top:10px">
          ุงูุงูุชุฑุงุถู ูุถุจูุท ุนูู 18 ูุจุฑุงูุฑ 2026. ูู ุฑูุถุงู ุงุฎุชูู ุงูุณูุฉ ุงูุฌุงูุฉ ุจุณ ุนุฏูู ุงูุชุงุฑูุฎ ููุง.
        </p>
        <div class="actions">
          <button class="btn primary" id="saveSettings">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
          <button class="btn danger" id="resetAll">ูุณุญ ูู ุงูุจูุงูุงุช</button>
        </div>
        <p class="mini dangerText" style="margin-top:10px">
          ูุณุญ ุงูุจูุงูุงุช = ุญุฐู ููุงุฆู ูู ุงูุฌูุงุฒ.
        </p>
      </div>
    </div>

  </div>

<script>
(() => {
  // --------------------
  // Storage
  // --------------------
  const KEY = "ramadan_pwa_v1";

  const defaultState = () => ({
    version: 1,
    settings: { startDate: "2026-02-18", daysCount: 30 },
    goals: [],
    days: {} // SAVED ONLY
  });

  const load = () => {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return defaultState();
      const s = JSON.parse(raw);
      return {
        ...defaultState(),
        ...s,
        settings: { ...defaultState().settings, ...(s.settings||{}) },
        goals: Array.isArray(s.goals) ? s.goals : [],
        days: (s.days && typeof s.days === "object") ? s.days : {}
      };
    } catch {
      return defaultState();
    }
  };

  const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));

  // --------------------
  // Helpers
  // --------------------
  const isoToday = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const isoAddDays = (iso, plus) => {
    const dt = new Date(iso);
    dt.setDate(dt.getDate() + plus);
    const yyyy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,"0");
    const dd = String(dt.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const fmtAr = (iso) => {
    const dt = new Date(iso);
    return dt.toLocaleDateString("ar-EG", {weekday:"long", year:"numeric", month:"long", day:"numeric"});
  };

  const dayOfWeek = (iso) => new Date(iso).getDay(); // 0 Sun .. 6 Sat
  const isFriday = (iso) => dayOfWeek(iso) === 5;

  const clamp = (n,a,b) => Math.min(b, Math.max(a, n));
  const round1 = (x) => Math.round(x * 10) / 10;

  // --------------------
  // UI
  // --------------------
  const $ = (id) => document.getElementById(id);

  const ui = {
    todayPill: $("todayPill"),
    ramadanLabel: $("ramadanLabel"),

    kpiTotal: $("kpiTotal"),
    kpiStreak: $("kpiStreak"),
    kpiAvg7: $("kpiAvg7"),
    kpiLogged: $("kpiLogged"),

    calendar: $("calendar"),
    selectedDayPill: $("selectedDayPill"),

    tabs: $("tabs"),
    tabContent: $("tabContent"),
    saveDayBtn: $("saveDayBtn"),
    deleteDayBtn: $("deleteDayBtn"),

    goalInput: $("goalInput"),
    addGoalBtn: $("addGoalBtn"),
    goalsList: $("goalsList"),
    goalsMeta: $("goalsMeta"),
    goalsBar: $("goalsBar"),

    exportBtn: $("exportBtn"),
    importBtn: $("importBtn"),

    settingsBtn: $("settingsBtn"),
    settingsModal: $("settingsModal"),
    closeSettings: $("closeSettings"),
    startDateInput: $("startDateInput"),
    daysCountInput: $("daysCountInput"),
    saveSettings: $("saveSettings"),
    resetAll: $("resetAll")
  };

  let state = load();
  let selectedIso = isoToday();
  let activeTab = "ุฑูุญุงูู";

  // --------------------
  // Scoring (100)
  // --------------------
  const WEIGHTS = {
    ุฑูุญุงูู: 45, ุตุญู: 15, ุดุฎุตู: 10, ุนุงุฆูู: 8, ุงุฌุชูุงุนู: 7, ูููู: 10, ูุงุฏู: 5
  };

  const PRAYERS = [
    { key:"sun_fajr2", label:"ุฑูุนุชู ุงููุฌุฑ (ุณูุฉ)", type:"sun", rakah:2 },
    { key:"fard_fajr", label:"ุงููุฌุฑ (ูุฑุถ)", type:"fard", rakah:2 },
    { key:"duha", label:"ุงูุถุญู (ุณูุฉ)", type:"sun", rakah:2 },

    { key:"sun_before_dhuhr4", label:"ูค ูุจู ุงูุธูุฑ (ุณูุฉ)", type:"sun", rakah:4 },
    { key:"fard_dhuhr", label:"ุงูุธูุฑ (ูุฑุถ)", type:"fard", rakah:4 },
    { key:"sun_after_dhuhr2", label:"ูข ุจุนุฏ ุงูุธูุฑ (ุณูุฉ)", type:"sun", rakah:2 },

    { key:"fard_asr", label:"ุงูุนุตุฑ (ูุฑุถ)", type:"fard", rakah:4 },

    { key:"fard_maghrib", label:"ุงููุบุฑุจ (ูุฑุถ)", type:"fard", rakah:3 },
    { key:"sun_after_maghrib2", label:"ูข ุจุนุฏ ุงููุบุฑุจ (ุณูุฉ)", type:"sun", rakah:2 },

    { key:"fard_isha", label:"ุงูุนุดุงุก (ูุฑุถ)", type:"fard", rakah:4 },
    { key:"sun_after_isha2", label:"ูข ุจุนุฏ ุงูุนุดุงุก (ุณูุฉ)", type:"sun", rakah:2 },

    { key:"taraweeh8", label:"ุงูุชุฑุงููุญ (ูจ ุฑูุนุงุช)", type:"sun", rakah:8 },
    { key:"witr", label:"ุงููุชุฑ (ูฃ ุฑูุนุงุช)", type:"fardlike", rakah:3 },
  ];

  const thikrItems = [
    {key:"thikr_morning", label:"ุฃุฐูุงุฑ ุงูุตุจุงุญ", points:2},
    {key:"thikr_evening", label:"ุฃุฐูุงุฑ ุงููุณุงุก", points:2},
    {key:"thikr_salat_nabi", label:"ูุฑุฏ ุงูุตูุงุฉ ุนูู ุงููุจู", points:1.5},
    {key:"thikr_hawqala", label:"ูุฑุฏ ุงูุญูููุฉ", points:1.5},
  ];

  const duaBase = [
    {key:"dua_before_fajr", label:"ูุจู ุงููุฌุฑ", points:1},
    {key:"dua_between_adhan_iqama", label:"ุจูู ุงูุฃุฐุงู ูุงูุฅูุงูุฉ", points:1},
    {key:"dua_after_salah", label:"ุจุนุฏ ุงูุตูุงุฉ", points:1},
    {key:"dua_before_iftar", label:"ูุจู ุงูุฅูุทุงุฑ", points:1},
    {key:"dua_last_third", label:"ุงูุซูุซ ุงูุฃุฎูุฑ ูู ุงูููู", points:1},
    {key:"dua_sujud", label:"ูู ุงูุณุฌูุฏ", points:1},
  ];
  const fridayBonus = {key:"dua_friday_asr", label:"ุงูุฌูุนุฉ: ุจุนุฏ ุงูุนุตุฑ ุญุชู ุงููุบุฑุจ (Bonus)", points:2};

  const healthItems = [
    {key:"health_teeth", label:"ุชูุฑูุด ุงูุฃุณูุงู", points:2},
    {key:"health_food", label:"ุฃูู ุตุญู", points:3},
    {key:"health_water", label:"ุดุฑุจ ูุงุก ูุงูู", points:3},
    {key:"health_sport", label:"ุฑูุงุถุฉ", points:3},
    {key:"health_shower", label:"ุงุณุชุญูุงู", points:2},
    {key:"health_look", label:"ุงูุงุนุชูุงุก ุจุงููุธูุฑ", points:2},
  ];

  const personalItems = [
    {key:"pers_read", label:"ูุฑุงุกุฉ", points:4},
    {key:"pers_listen", label:"ุณูุงุน", points:3},
    {key:"pers_fun", label:"ุชุฑููุญ", points:3},
  ];

  const familyItems = [
    {key:"fam_parents", label:"ุจุฑ ุงููุงูุฏูู", points:5},
    {key:"fam_help", label:"ูุณุงุนุฏุฉ ูู ุงูุจูุช", points:3},
  ];

  const socialItems = [
    {key:"soc_taarafu", label:"ูุชุนุงุฑููุง", points:7},
  ];

  const moneyItems = [
    {key:"money_sadaqa", label:"ุงูุตุฏูุฉ", points:3},
    {key:"money_earn", label:"ุงููุณุจ / ุฅูุชุงุฌ", points:2},
  ];

  const profCategories = [
    "ุงููุฐุงูุฑุฉ","KIT Project","English learning","ููุงุฉ ุชุฑุงุซ","ุชุทููุฑ ููุงุฑุฉ","Other"
  ];

  // --------------------
  // Draft system (days are not saved until user clicks save)
  // --------------------
  const drafts = {}; // drafts[iso] = dayData

  const makeEmptyDay = () => ({
    prayers: Object.fromEntries(PRAYERS.map(p => [p.key, false])),
    qiyamRakah: 0,
    thikr: Object.fromEntries(thikrItems.map(x => [x.key, false])),
    dua: Object.fromEntries([...duaBase, fridayBonus].map(x => [x.key, false])),
    duaFocus: "",

    // โ NEW: Quran
    quranPages: 0,

    health: Object.fromEntries(healthItems.map(x => [x.key, false])),
    personal: Object.fromEntries(personalItems.map(x => [x.key, false])),
    family: Object.fromEntries(familyItems.map(x => [x.key, false])),
    social: Object.fromEntries(socialItems.map(x => [x.key, false])),
    money: Object.fromEntries(moneyItems.map(x => [x.key, false])),

    professional: Object.fromEntries(profCategories.map(c => [c, [{text:"", done:false}]])),
    notes: "",

    // โ NEW: Bonus tasks per side
    bonus: {
      ุฑูุญุงูู: [{ text:"", points:1, done:false }],
      ุตุญู:   [{ text:"", points:1, done:false }],
      ุดุฎุตู:  [{ text:"", points:1, done:false }],
      ุนุงุฆูู: [{ text:"", points:1, done:false }],
      ุงุฌุชูุงุนู:[{ text:"", points:1, done:false }],
      ูููู:  [{ text:"", points:1, done:false }],
      ูุงุฏู:  [{ text:"", points:1, done:false }],
    }
  });

  const getDay = (iso) => {
    if (drafts[iso]) return drafts[iso];
    if (state.days[iso]) return state.days[iso];
    drafts[iso] = makeEmptyDay();
    return drafts[iso];
  };

  const saveDay = (iso) => {
    state.days[iso] = getDay(iso);
    delete drafts[iso];
    save(state);
  };

  const deleteDay = (iso) => {
    if (state.days[iso]) delete state.days[iso];
    if (drafts[iso]) delete drafts[iso];
    save(state);
  };

  // --------------------
  // Scoring calc
  // --------------------
  const calcPrayersRaw = (day) => {
    let raw = 0;
    for (const p of PRAYERS) {
      if (!day.prayers[p.key]) continue;
      if (p.type === "fard") raw += p.rakah * 1;
      else if (p.type === "sun") raw += p.rakah * 2;
      else raw += p.rakah * 1;
    }
    const qiyam = clamp(+day.qiyamRakah || 0, 0, 60);
    raw += qiyam * 2;
    return raw;
  };

  const calcThikr = (day) =>
    thikrItems.reduce((acc,x)=> acc + (day.thikr[x.key] ? x.points : 0), 0);

  const calcDua = (day, iso) => {
    const items = [...duaBase, ...(isFriday(iso) ? [fridayBonus] : [])];
    return items.reduce((acc,x)=> acc + (day.dua[x.key] ? x.points : 0), 0);
  };

  // โ Quran: ูู 4 ุตูุญุงุช = 1 ููุทุฉ (ุญุฏ ุฃูุตู 5)
  const calcQuran = (day) => {
    const pages = clamp(+day.quranPages || 0, 0, 200);
    return round1(clamp(pages / 4, 0, 5));
  };

  // โ Bonus per side (no cap) โ counts only if text exists + done
  const calcBonusSide = (day, sideKey) => {
    const arr = (day.bonus && day.bonus[sideKey]) ? day.bonus[sideKey] : [];
    let s = 0;
    for (const t of arr) {
      if (!t) continue;
      const pts = clamp(+t.points || 0, 0, 20);
      if (t.done && t.text && t.text.trim()) s += pts;
    }
    return round1(s);
  };

  // โ ุฑูุญุงูู = 45 (ุตููุงุช 28 + ุฃุฐูุงุฑ 6 + ุฏุนุงุก 6 + ูุฑุขู 5)
  const calcSpiritual = (day, iso) => {
    const prayersRaw = calcPrayersRaw(day);

    const baselineMaxRaw =
      PRAYERS.reduce((acc,p)=>{
        const mult = (p.type === "sun") ? 2 : 1;
        return acc + p.rakah * mult;
      }, 0) + (10 * 2);

    const prayersNorm = clamp((prayersRaw / baselineMaxRaw) * 28, 0, 28);
    const thikr = clamp(calcThikr(day), 0, 6);
    const dua = clamp(calcDua(day, iso), 0, 6);
    const quran = clamp(calcQuran(day), 0, 5);

    return {
      prayers: round1(prayersNorm),
      thikr: round1(thikr),
      dua: round1(dua),
      quran: round1(quran),
      total: round1(prayersNorm + thikr + dua + quran)
    };
  };

  const sumCheckItems = (dayObj, items, cap) => {
    const s = items.reduce((acc,x)=> acc + (dayObj[x.key] ? x.points : 0), 0);
    return cap != null ? clamp(s, 0, cap) : s;
  };

  const calcProfessional = (day) => {
    let done = 0;
    for (const cat of profCategories) {
      const tasks = day.professional[cat] || [];
      for (const t of tasks) if (t && t.done && t.text && t.text.trim()) done++;
    }
    return clamp(done, 0, 10);
  };

  // calcAll: if source="saved" => saved only, else uses draft if exists
  const calcAll = (iso, source="auto") => {
    const day = (source === "saved") ? (state.days[iso] || null) : getDay(iso);

    if (!day) {
      return {
        breakdown: {"ุฑูุญุงูู":0,"ุตุญู":0,"ุดุฎุตู":0,"ุนุงุฆูู":0,"ุงุฌุชูุงุนู":0,"ูููู":0,"ูุงุฏู":0},
        spiritualParts: {prayers:0,thikr:0,dua:0,quran:0,total:0},
        bonusParts: {"ุฑูุญุงูู":0,"ุตุญู":0,"ุดุฎุตู":0,"ุนุงุฆูู":0,"ุงุฌุชูุงุนู":0,"ูููู":0,"ูุงุฏู":0},
        total: 0
      };
    }

    const spiritual = calcSpiritual(day, iso);
    const health = clamp(sumCheckItems(day.health, healthItems), 0, WEIGHTS.ุตุญู);
    const personal = clamp(sumCheckItems(day.personal, personalItems), 0, WEIGHTS.ุดุฎุตู);
    const family = clamp(sumCheckItems(day.family, familyItems), 0, WEIGHTS.ุนุงุฆูู);
    const social = clamp(sumCheckItems(day.social, socialItems), 0, WEIGHTS.ุงุฌุชูุงุนู);
    const money = clamp(sumCheckItems(day.money, moneyItems), 0, WEIGHTS.ูุงุฏู);
    const professional = clamp(calcProfessional(day), 0, WEIGHTS.ูููู);

    const bonus = {
      "ุฑูุญุงูู": calcBonusSide(day, "ุฑูุญุงูู"),
      "ุตุญู": calcBonusSide(day, "ุตุญู"),
      "ุดุฎุตู": calcBonusSide(day, "ุดุฎุตู"),
      "ุนุงุฆูู": calcBonusSide(day, "ุนุงุฆูู"),
      "ุงุฌุชูุงุนู": calcBonusSide(day, "ุงุฌุชูุงุนู"),
      "ูููู": calcBonusSide(day, "ูููู"),
      "ูุงุฏู": calcBonusSide(day, "ูุงุฏู"),
    };

    const breakdown = {
      "ุฑูุญุงูู": round1(spiritual.total + bonus["ุฑูุญุงูู"]),
      "ุตุญู": round1(health + bonus["ุตุญู"]),
      "ุดุฎุตู": round1(personal + bonus["ุดุฎุตู"]),
      "ุนุงุฆูู": round1(family + bonus["ุนุงุฆูู"]),
      "ุงุฌุชูุงุนู": round1(social + bonus["ุงุฌุชูุงุนู"]),
      "ูููู": round1(professional + bonus["ูููู"]),
      "ูุงุฏู": round1(money + bonus["ูุงุฏู"])
    };

    const total = round1(
      breakdown["ุฑูุญุงูู"] + breakdown["ุตุญู"] + breakdown["ุดุฎุตู"] +
      breakdown["ุนุงุฆูู"] + breakdown["ุงุฌุชูุงุนู"] + breakdown["ูููู"] + breakdown["ูุงุฏู"]
    );

    return {
      breakdown,
      spiritualParts: spiritual,
      bonusParts: bonus,
      total
    };
  };

  // --------------------
  // Ramadan dates
  // --------------------
  const getRamadanDates = () => {
    const start = state.settings.startDate;
    const count = clamp(+state.settings.daysCount || 30, 29, 30);
    return Array.from({length: count}, (_,i)=> isoAddDays(start, i));
  };

  const isInRamadan = (iso) => {
    const dates = getRamadanDates();
    return iso >= dates[0] && iso <= dates[dates.length-1];
  };

  // --------------------
  // Streak (saved only)
  // --------------------
  const streakThreshold = 70;
  const calcStreak = () => {
    let streak = 0;
    let cur = isoToday();
    while (true) {
      if (!state.days[cur]) break;
      const t = calcAll(cur, "saved").total;
      if (t < streakThreshold) break;
      streak++;
      cur = isoAddDays(cur, -1);
    }
    return streak;
  };

  const avgLastN = (n=7) => {
    const dates = Object.keys(state.days).sort();
    const last = dates.slice(-n);
    if (!last.length) return null;
    const sum = last.reduce((acc,iso)=> acc + calcAll(iso, "saved").total, 0);
    return round1(sum/last.length);
  };

  // --------------------
  // Tabs
  // --------------------
  const TAB_KEYS = ["ุฑูุญุงูู","ุตุญู","ุดุฎุตู","ุนุงุฆูู","ุงุฌุชูุงุนู","ูููู","ูุงุฏู","ููุงุญุธุงุช"];

  const renderTabs = () => {
    ui.tabs.innerHTML = "";
    for (const t of TAB_KEYS) {
      const b = document.createElement("button");
      b.className = "tab" + (t === activeTab ? " active" : "");
      b.textContent = t;
      b.addEventListener("click", ()=>{
        activeTab = t;
        renderTabs();
        renderTabContent();
      });
      ui.tabs.appendChild(b);
    }
  };

  // --------------------
  // Charts
  // --------------------
  let lineChart, donutChart;

  const renderCharts = () => {
    const ramadanDates = getRamadanDates();

    const labels = ramadanDates.map((iso, idx)=> `ู${idx+1}`);
    const dataSaved = ramadanDates.map(iso => state.days[iso] ? calcAll(iso, "saved").total : null);

    const ctx1 = document.getElementById("lineChart").getContext("2d");
    if (lineChart) lineChart.destroy();
    lineChart = new Chart(ctx1, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "ุงูููุงุท / 100",
          data: dataSaved,
          spanGaps: false,
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { suggestedMin: 0, suggestedMax: 120 } }
      }
    });

    const sc = calcAll(selectedIso); // live (draft)
    const keys = Object.keys(sc.breakdown);
    const vals = keys.map(k => sc.breakdown[k]);

    const ctx2 = document.getElementById("donutChart").getContext("2d");
    if (donutChart) donutChart.destroy();
    donutChart = new Chart(ctx2, {
      type: "doughnut",
      data: { labels: keys, datasets: [{ data: vals, borderWidth: 1 }] },
      options: { plugins: { legend: { position: "bottom" } } }
    });
  };

  // --------------------
  // Calendar
  // --------------------
  const renderCalendar = () => {
    ui.calendar.innerHTML = "";
    const ramadanDates = getRamadanDates();

    const colIndex = (dow) => { if (dow === 6) return 0; return dow + 1; }; // Sat=0..Fri=6
    const pad = colIndex(dayOfWeek(ramadanDates[0]));
    for (let i=0;i<pad;i++){
      const empty = document.createElement("div");
      empty.style.opacity = "0";
      empty.className = "day";
      empty.style.pointerEvents = "none";
      ui.calendar.appendChild(empty);
    }

    ramadanDates.forEach((iso, idx) => {
      const isSaved = !!state.days[iso];
      const score = isSaved ? calcAll(iso, "saved").total : null;

      const cell = document.createElement("div");
      cell.className = "day";
      if (iso === selectedIso) cell.classList.add("active");
      if (isSaved) cell.classList.add("done");
      if (isSaved && score >= 85) cell.classList.add("best");

      cell.innerHTML = `
        <div class="d">ุงูููู ${idx+1}</div>
        <div class="mini">${fmtAr(iso).replace(/^.+ุ\\s*/,"")}</div>
        <div class="s">${score == null ? "โ" : (score + "/100")}</div>
      `;
      cell.addEventListener("click", ()=>{
        selectedIso = iso;
        renderAll(); // switch day
      });

      ui.calendar.appendChild(cell);
    });
  };

  // --------------------
  // Goals
  // --------------------
  const renderGoals = () => {
    ui.goalsList.innerHTML = "";

    if (!state.goals.length) {
      const x = document.createElement("div");
      x.className = "mini";
      x.textContent = "ูููุด ุฃูุฏุงู ูุณู โ ุงูุชุจ ูุฏู ุจุณูุท ูุชุงุจุน ุชูุฏูู.";
      ui.goalsList.appendChild(x);
      ui.goalsMeta.textContent = "0/0";
      ui.goalsBar.style.width = "0%";
      return;
    }

    const done = state.goals.filter(g=>g.done).length;
    ui.goalsMeta.textContent = `${done}/${state.goals.length}`;
    ui.goalsBar.style.width = `${(done/state.goals.length)*100}%`;

    state.goals.forEach((g, i) => {
      const row = document.createElement("div");
      row.className = "goal";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!g.done;
      cb.addEventListener("change", ()=>{
        g.done = cb.checked;
        save(state);
        renderAll();
      });

      const t = document.createElement("div");
      t.className = "t";
      t.textContent = g.text;
      t.style.textDecoration = g.done ? "line-through" : "none";
      t.style.color = g.done ? "rgba(234,240,255,.70)" : "var(--text)";

      const del = document.createElement("button");
      del.className = "btn danger";
      del.textContent = "ุญุฐู";
      del.addEventListener("click", ()=>{
        state.goals.splice(i,1);
        save(state);
        renderAll();
      });

      row.appendChild(cb);
      row.appendChild(t);
      row.appendChild(del);
      ui.goalsList.appendChild(row);
    });
  };

  // --------------------
  // KPIs
  // --------------------
  const renderKPIs = () => {
    ui.todayPill.textContent = `ุงูููู: ${fmtAr(isoToday())}`;

    const ramDates = getRamadanDates();
    ui.ramadanLabel.textContent = `ุฑูุถุงู: ูู ${fmtAr(ramDates[0])} ุฅูู ${fmtAr(ramDates[ramDates.length-1])}`;

    const scLive = calcAll(selectedIso);
    ui.kpiTotal.textContent = `${scLive.total}`;

    ui.kpiStreak.textContent = calcStreak();
    const a7 = avgLastN(7);
    ui.kpiAvg7.textContent = a7 == null ? "โ" : a7;
    ui.kpiLogged.textContent = Object.keys(state.days).length;
  };

  // --------------------
  // Live refresh
  // --------------------
  const refreshLive = () => {
    renderKPIs();
    renderTabContent();
    renderCharts();
    renderCalendar();
  };

  // --------------------
  // UI builders
  // --------------------
  const mkCheck = (label, checked, onChange) => {
    const line = document.createElement("div");
    line.className = "checkline";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!checked;
    cb.addEventListener("change", ()=> { onChange(cb.checked); refreshLive(); });
    const txt = document.createElement("div");
    txt.textContent = label;
    txt.style.flex = "1";
    line.appendChild(cb);
    line.appendChild(txt);
    return line;
  };

  // โ Bonus UI
  const renderBonusTasks = (day, sideKey) => {
    const box = document.createElement("div");
    box.appendChild(Object.assign(document.createElement("div"), {
      className:"sectionTitle",
      textContent:`โจ ููุงู ุฅุถุงููุฉ (Bonus) โ ${sideKey}`
    }));

    day.bonus = day.bonus || {};
    day.bonus[sideKey] = day.bonus[sideKey] || [{ text:"", points:1, done:false }];
    const arr = day.bonus[sideKey];

    const rerender = () => {
      box.querySelectorAll(".bonusRow").forEach(n=>n.remove());

      arr.forEach((t, idx) => {
        const row = document.createElement("div");
        row.className = "checkline bonusRow";
        row.style.display = "grid";
        row.style.gridTemplateColumns = "28px 1fr 90px 70px";
        row.style.gap = "10px";
        row.style.alignItems = "center";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!t.done;
        cb.addEventListener("change", ()=>{ t.done = cb.checked; refreshLive(); });

        const inpText = document.createElement("input");
        inpText.placeholder = "ุงูุชุจ ุงููููุฉ ุงูุฅุถุงููุฉโฆ";
        inpText.value = t.text || "";
        inpText.addEventListener("input", ()=>{ t.text = inpText.value; refreshLive(); });

        const inpPts = document.createElement("input");
        inpPts.type = "number";
        inpPts.min = "0"; inpPts.max = "20";
        inpPts.value = (t.points ?? 1);
        inpPts.addEventListener("input", ()=>{ t.points = clamp(+inpPts.value || 0, 0, 20); refreshLive(); });

        const del = document.createElement("button");
        del.className = "btn danger";
        del.textContent = "ุญุฐู";
        del.addEventListener("click", ()=>{
          arr.splice(idx,1);
          if (!arr.length) arr.push({ text:"", points:1, done:false });
          rerender();
          refreshLive();
        });

        row.appendChild(cb);
        row.appendChild(inpText);
        row.appendChild(inpPts);
        row.appendChild(del);
        box.appendChild(row);
      });
    };

    const add = document.createElement("button");
    add.className = "btn ghost";
    add.textContent = "โ ุฅุถุงูุฉ ูููุฉ Bonus";
    add.addEventListener("click", ()=>{
      arr.push({ text:"", points:1, done:false });
      rerender();
      refreshLive();
    });

    const meta = document.createElement("div");
    meta.className = "mini";
    meta.style.marginTop = "6px";
    meta.textContent = `Bonus ุงูุญุงูู: ${calcBonusSide(day, sideKey)} ููุทุฉ`;

    rerender();
    box.appendChild(add);
    box.appendChild(meta);
    return box;
  };

  const renderTabContent = () => {
    const day = getDay(selectedIso);
    ui.selectedDayPill.textContent = fmtAr(selectedIso);

    const wrap = document.createElement("div");

    if (activeTab === "ุฑูุญุงูู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ ุงูุตููุงุช"}));
      for (const p of PRAYERS) {
        wrap.appendChild(mkCheck(p.label, day.prayers[p.key], (v)=>{ day.prayers[p.key]=v; }));
      }

      const q = document.createElement("div");
      q.className = "checkline";
      q.style.display = "grid";
      q.style.gridTemplateColumns = "1fr 160px";
      q.style.gap = "10px";
      q.style.alignItems = "center";
      q.innerHTML = `<div>ููุงู ุงูููู (ุงูุชุจ ุนุฏุฏ ุงูุฑูุนุงุช)</div>`;
      const inp = document.createElement("input");
      inp.type = "number"; inp.min="0"; inp.max="60";
      inp.value = day.qiyamRakah || 0;
      inp.addEventListener("input", ()=> { day.qiyamRakah = clamp(+inp.value||0,0,60); refreshLive(); });
      q.appendChild(inp);
      wrap.appendChild(q);

      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ฟ ุงูุฃุฐูุงุฑ"}));
      for (const x of thikrItems) {
        wrap.appendChild(mkCheck(x.label, day.thikr[x.key], (v)=>{ day.thikr[x.key]=v; }));
      }

      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐คฒ ุงูุฏุนุงุก"}));
      const duaItemsToday = [...duaBase, ...(isFriday(selectedIso) ? [fridayBonus] : [])];
      for (const x of duaItemsToday) {
        wrap.appendChild(mkCheck(x.label, day.dua[x.key], (v)=>{ day.dua[x.key]=v; }));
      }

      // โ Quran block
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ ูุฑุฏ ุงููุฑุขู"}));
      const qb = document.createElement("div");
      qb.className = "checkline";
      qb.style.display = "grid";
      qb.style.gridTemplateColumns = "1fr 160px";
      qb.style.gap = "10px";
      qb.style.alignItems = "center";
      qb.innerHTML = `<div>ุนุฏุฏ ุงูุตูุญุงุช ุงูููุฑูุกุฉ ุงูููู</div>`;
      const inpPages = document.createElement("input");
      inpPages.type = "number"; inpPages.min="0"; inpPages.max="200";
      inpPages.value = day.quranPages || 0;
      inpPages.addEventListener("input", ()=> { day.quranPages = clamp(+inpPages.value||0,0,200); refreshLive(); });
      qb.appendChild(inpPages);
      wrap.appendChild(qb);

      const qinfo = document.createElement("div");
      qinfo.className = "mini";
      qinfo.style.marginTop = "6px";
      qinfo.textContent = `ููุงุท ุงููุฑุขู: ${calcQuran(day)}/5 โ ูู 4 ุตูุญุงุช = 1 ููุทุฉ`;
      wrap.appendChild(qinfo);

      const focus = document.createElement("label");
      focus.textContent = "ุงูุฏุนูุงุช ุงููู ูุชุฑูุฒ ุนูููุง ุงูููู";
      const ta = document.createElement("textarea");
      ta.value = day.duaFocus || "";
      ta.placeholder = "ุงูุชุจ ุงูุฃุฏุนูุฉ ุงูุฃุณุงุณูุฉโฆ";
      ta.addEventListener("input", ()=> { day.duaFocus = ta.value; refreshLive(); });
      focus.appendChild(ta);
      wrap.appendChild(focus);

      wrap.appendChild(renderBonusTasks(day, "ุฑูุญุงูู"));

      const sc = calcAll(selectedIso);
      const hint = document.createElement("div");
      hint.className = "mini";
      hint.style.marginTop = "8px";
      hint.textContent =
        `ุฑูุญุงูู ุงูููู: ${sc.breakdown["ุฑูุญุงูู"]} (ุฃุณุงุณ ${sc.spiritualParts.total}/45 + Bonus ${sc.bonusParts["ุฑูุญุงูู"]}) โ (ุตููุงุช ${sc.spiritualParts.prayers}/28 + ุฃุฐูุงุฑ ${sc.spiritualParts.thikr}/6 + ุฏุนุงุก ${sc.spiritualParts.dua}/6 + ูุฑุขู ${sc.spiritualParts.quran}/5)`;
      wrap.appendChild(hint);
    }

    if (activeTab === "ุตุญู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ช ุงูุฌุงูุจ ุงูุตุญู"}));
      for (const x of healthItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.health[x.key], (v)=>{ day.health[x.key]=v; }));
      }
      wrap.appendChild(renderBonusTasks(day, "ุตุญู"));
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`ุญุฏ ุฃูุตู ุงูุฃุณุงุณ: ${WEIGHTS.ุตุญู} ููุทุฉ (+ Bonus)`}));
    }

    if (activeTab === "ุดุฎุตู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ง ุงูุฌุงูุจ ุงูุดุฎุตู"}));
      for (const x of personalItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.personal[x.key], (v)=>{ day.personal[x.key]=v; }));
      }
      wrap.appendChild(renderBonusTasks(day, "ุดุฎุตู"));
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`ุญุฏ ุฃูุตู ุงูุฃุณุงุณ: ${WEIGHTS.ุดุฎุตู} ููุทุฉ (+ Bonus)`}));
    }

    if (activeTab === "ุนุงุฆูู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐จโ๐ฉโ๐ฆ ุงูุฌุงูุจ ุงูุนุงุฆูู"}));
      for (const x of familyItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.family[x.key], (v)=>{ day.family[x.key]=v; }));
      }
      wrap.appendChild(renderBonusTasks(day, "ุนุงุฆูู"));
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`ุญุฏ ุฃูุตู ุงูุฃุณุงุณ: ${WEIGHTS.ุนุงุฆูู} ููุทุฉ (+ Bonus)`}));
    }

    if (activeTab === "ุงุฌุชูุงุนู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ ุงูุฌุงูุจ ุงูุงุฌุชูุงุนู"}));
      for (const x of socialItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.social[x.key], (v)=>{ day.social[x.key]=v; }));
      }
      wrap.appendChild(renderBonusTasks(day, "ุงุฌุชูุงุนู"));
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`ุญุฏ ุฃูุตู ุงูุฃุณุงุณ: ${WEIGHTS.ุงุฌุชูุงุนู} ููุทุฉ (+ Bonus)`}));
    }

    if (activeTab === "ูููู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ผ ุงูุฌุงูุจ ุงููููู"}));
      const info = document.createElement("div");
      info.className = "mini";
      info.textContent = "ูู ูููุฉ โ = 1 ููุทุฉ (ุญุฏ ุฃูุตู 10). ุงูุชุจ ููุงูู ุชุญุช ูู ุจูุฏ.";
      wrap.appendChild(info);

      for (const cat of profCategories) {
        const title = document.createElement("div");
        title.className = "sectionTitle";
        title.textContent = "โข " + cat;
        wrap.appendChild(title);

        const tasks = day.professional[cat] || [{text:"", done:false}];

        tasks.forEach((t, idx) => {
          const line = document.createElement("div");
          line.className = "checkline";
          line.style.display = "grid";
          line.style.gridTemplateColumns = "28px 1fr 80px";
          line.style.gap = "10px";
          line.style.alignItems = "center";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = !!t.done;
          cb.addEventListener("change", ()=> { t.done = cb.checked; refreshLive(); });

          const inp = document.createElement("input");
          inp.placeholder = "ุงูุชุจ ุงููููุฉโฆ";
          inp.value = t.text || "";
          inp.addEventListener("input", ()=> { t.text = inp.value; refreshLive(); });

          const del = document.createElement("button");
          del.className = "btn danger";
          del.textContent = "ุญุฐู";
          del.addEventListener("click", ()=>{
            const arr = day.professional[cat] || [];
            arr.splice(idx,1);
            if (arr.length === 0) arr.push({text:"", done:false});
            day.professional[cat] = arr;
            refreshLive();
          });

          line.appendChild(cb);
          line.appendChild(inp);
          line.appendChild(del);
          wrap.appendChild(line);
        });

        const add = document.createElement("button");
        add.className = "btn ghost";
        add.textContent = "โ ุฅุถุงูุฉ ูููุฉ";
        add.addEventListener("click", ()=>{
          day.professional[cat] = (day.professional[cat] || []);
          day.professional[cat].push({text:"", done:false});
          refreshLive();
        });
        wrap.appendChild(add);
      }

      wrap.appendChild(renderBonusTasks(day, "ูููู"));

      const sc = calcAll(selectedIso);
      const hint = document.createElement("div");
      hint.className = "mini";
      hint.style.marginTop = "8px";
      hint.textContent = `ูููู ุงูููู (Live): ${sc.breakdown["ูููู"]}/10 (+ Bonus)`;
      wrap.appendChild(hint);
    }

    if (activeTab === "ูุงุฏู") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐ฐ ุงูุฌุงูุจ ุงููุงุฏู"}));
      for (const x of moneyItems) {
        wrap.appendChild(mkCheck(`${x.label} (${x.points})`, day.money[x.key], (v)=>{ day.money[x.key]=v; }));
      }
      wrap.appendChild(renderBonusTasks(day, "ูุงุฏู"));
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"mini", textContent:`ุญุฏ ุฃูุตู ุงูุฃุณุงุณ: ${WEIGHTS.ูุงุฏู} ููุทุฉ (+ Bonus)`}));
    }

    if (activeTab === "ููุงุญุธุงุช") {
      wrap.appendChild(Object.assign(document.createElement("div"), {className:"sectionTitle", textContent:"๐๏ธ ููุงุญุธุงุช ุงูููู"}));
      const note = document.createElement("textarea");
      note.value = day.notes || "";
      note.placeholder = "ุงูุชุจ ุฅูุฌุงุฒุงุชู/ุชุนูููู/ูุฑุงุฌุนุฉ ุณุฑูุนุฉ ูููููโฆ";
      note.addEventListener("input", ()=> { day.notes = note.value; refreshLive(); });
      wrap.appendChild(note);

      const sc = calcAll(selectedIso);
      const box = document.createElement("div");
      box.className = "mini";
      box.style.marginTop = "10px";
      box.textContent =
        `Total (Live): ${sc.total}/100 โ ุฑูุญุงูู ${sc.breakdown["ุฑูุญุงูู"]} โข ุตุญู ${sc.breakdown["ุตุญู"]} โข ุดุฎุตู ${sc.breakdown["ุดุฎุตู"]} โข ุนุงุฆูู ${sc.breakdown["ุนุงุฆูู"]} โข ุงุฌุชูุงุนู ${sc.breakdown["ุงุฌุชูุงุนู"]} โข ูููู ${sc.breakdown["ูููู"]} โข ูุงุฏู ${sc.breakdown["ูุงุฏู"]}`;
      wrap.appendChild(box);
    }

    ui.tabContent.innerHTML = "";
    ui.tabContent.appendChild(wrap);
  };

  // --------------------
  // Actions
  // --------------------
  ui.saveDayBtn.addEventListener("click", ()=>{
    saveDay(selectedIso);
    renderAll();
  });

  ui.deleteDayBtn.addEventListener("click", ()=>{
    deleteDay(selectedIso);
    renderAll();
  });

  ui.addGoalBtn.addEventListener("click", ()=>{
    const txt = (ui.goalInput.value || "").trim();
    if (!txt) return;
    state.goals.unshift({ text: txt, done:false, createdAt: Date.now() });
    ui.goalInput.value = "";
    save(state);
    renderAll();
  });

  ui.exportBtn.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ramadan-tracker-backup-${isoToday()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  ui.importBtn.addEventListener("click", ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = () => {
      const file = inp.files && inp.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const parsed = JSON.parse(r.result);
          if(!parsed || typeof parsed !== "object") throw new Error("bad");
          state = {
            ...defaultState(),
            ...parsed,
            settings: { ...defaultState().settings, ...(parsed.settings||{}) },
            goals: Array.isArray(parsed.goals) ? parsed.goals : [],
            days: (parsed.days && typeof parsed.days === "object") ? parsed.days : {}
          };
          save(state);
          renderAll();
        }catch{
          alert("ููู ุงูุงุณุชูุฑุงุฏ ุบูุฑ ุตุงูุญ.");
        }
      };
      r.readAsText(file);
    };
    inp.click();
  });

  // Settings modal
  const openSettings = () => {
    ui.startDateInput.value = state.settings.startDate;
    ui.daysCountInput.value = state.settings.daysCount;
    ui.settingsModal.style.display = "block";
  };
  const closeSettings = () => ui.settingsModal.style.display = "none";

  ui.settingsBtn.addEventListener("click", openSettings);
  ui.closeSettings.addEventListener("click", closeSettings);
  ui.settingsModal.addEventListener("click", (e)=>{
    if (e.target === ui.settingsModal) closeSettings();
  });

  ui.saveSettings.addEventListener("click", ()=>{
    const d = ui.startDateInput.value || "2026-02-18";
    const c = clamp(+ui.daysCountInput.value || 30, 29, 30);
    state.settings.startDate = d;
    state.settings.daysCount = c;

    const r = getRamadanDates();
    if (!isInRamadan(selectedIso)) selectedIso = r[0];

    save(state);
    closeSettings();
    renderAll();
  });

  ui.resetAll.addEventListener("click", ()=>{
    const ok = confirm("ูุชุฃูุฏุ ูุชูุณุญ ูู ุงูุจูุงูุงุช ููุงุฆููุง.");
    if (!ok) return;
    state = defaultState();
    save(state);
    selectedIso = state.settings.startDate;
    closeSettings();
    renderAll();
  });

  // --------------------
  // Main render
  // --------------------
  const renderAll = () => {
    const ram = getRamadanDates();
    if (!isInRamadan(selectedIso)) {
      selectedIso = isInRamadan(isoToday()) ? isoToday() : ram[0];
    }

    renderTabs();
    renderKPIs();
    renderCalendar();
    renderGoals();
    renderTabContent();
    renderCharts();
  };

  // init
  renderAll();

  // register SW (ููุง ูุงู ุนูุฏู)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
})();
</script>
</body>
</html>
